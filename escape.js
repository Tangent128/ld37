var __extends=this&&this.__extends||function(d,b){for(var p in b)if(b.hasOwnProperty(p))d[p]=b[p];function __(){this.constructor=d}d.prototype=b===null?Object.create(b):(__.prototype=b.prototype,new __)};var __decorate=this&&this.__decorate||function(decorators,target,key,desc){var c=arguments.length,r=c<3?target:desc===null?desc=Object.getOwnPropertyDescriptor(target,key):desc,d;if(typeof Reflect==="object"&&typeof Reflect.decorate==="function")r=Reflect.decorate(decorators,target,key,desc);else for(var i=decorators.length-1;i>=0;i--)if(d=decorators[i])r=(c<3?d(r):c>3?d(target,key,r):d(target,key))||r;return c>3&&r&&Object.defineProperty(target,key,r),r};var Applet;(function(Applet){var KEY_NAMES={90:"a",88:"b",67:"menu",87:"up",83:"down",65:"left",68:"right",32:"a",16:"b",13:"menu",38:"up",40:"down",37:"left",39:"right"};var KeyControl=function(){function KeyControl(element,tabindex){var _this=this;if(tabindex===void 0){tabindex=-1}this.element=element;this.actionStack=[];this.keyUp=function(evt){_this.dispatch(evt,"release")};this.keyDown=function(evt){_this.dispatch(evt,"press")};element.addEventListener("keyup",this.keyUp,false);element.addEventListener("keydown",this.keyDown,false);element.setAttribute("tabindex",tabindex+"")}KeyControl.prototype.dispose=function(){this.element.removeEventListener("keyup",this.keyUp,false);this.element.removeEventListener("keydown",this.keyDown,false)};KeyControl.prototype.push=function(actions){this.actionStack.push(actions)};KeyControl.prototype.pop=function(){this.actionStack.pop()};KeyControl.prototype.dispatch=function(evt,state){var name=KEY_NAMES[evt.which];if(name!=null&&this.actionStack.length>0){evt.preventDefault();evt.stopPropagation();var handler=this.actionStack[this.actionStack.length-1][name];if(state=="press"&&handler.press){handler.press()}else if(state=="release"&&handler.release){handler.release()}}};KeyControl.prototype.focus=function(){this.element.focus()};return KeyControl}();Applet.KeyControl=KeyControl;function Bind(selector){return function(appletType){var elements=document.querySelectorAll(selector);for(var i=0;i<elements.length;i++){var element=elements[i];new appletType(element)}}}Applet.Bind=Bind})(Applet||(Applet={}));var ECS;(function(ECS){var System=function(){function System(filter){this.filter=filter}System.prototype.run=function(list){this.start();for(var _i=0,list_1=list;_i<list_1.length;_i++){var item=list_1[_i];if(!item.deleted&&this.filter(item)){this.process(item)}}this.finish()};System.prototype.start=function(){};System.prototype.finish=function(){};return System}();ECS.System=System;var Room=function(){function Room(fps){this.fps=fps;this.lastPhysicsTick=0;this.Entities=[]}Room.prototype.add=function(entity){this.Entities.push(entity)};Room.prototype.cleanup=function(){this.Entities=this.Entities.filter(function(entity){return!entity.deleted})};return Room}();ECS.Room=Room;var Loop=function(){function Loop(room,cx){this.room=room;this.cx=cx;this.physicsTimeout=null;this.renderTimeout=null}Loop.prototype.start=function(){var _this=this;if(this.physicsTimeout==null){var interval=1e3/this.room.fps;this.physicsTimeout=window.setTimeout(function(){_this.physicsTimeout=null;_this.physicsTick()},interval)}if(this.renderTimeout==null){this.renderTimeout=window.requestAnimationFrame(function(){_this.renderTimeout=null;_this.renderTick()})}};Loop.prototype.stop=function(){if(this.physicsTimeout!=null){window.clearTimeout(this.physicsTimeout);this.physicsTimeout=null}if(this.renderTimeout!=null){window.cancelAnimationFrame(this.renderTimeout);this.renderTimeout=null}};Loop.prototype.physicsTick=function(){var now=(new Date).getTime();this.room.runPhysics();this.room.lastPhysicsTick=now;this.start()};Loop.prototype.renderTick=function(){var now=(new Date).getTime();this.room.runRender(this.cx);this.start()};return Loop}();ECS.Loop=Loop})(ECS||(ECS={}));var Render;(function(Render){var Box=function(){function Box(x,y,w,h){this.x=x;this.y=y;this.w=w;this.h=h}return Box}();Render.Box=Box;var Camera=function(){function Camera(){this.x=0;this.y=0;this.zoom=1}return Camera}();Render.Camera=Camera;var Layer=function(){function Layer(z,parallax,scale){if(parallax===void 0){parallax=1}if(scale===void 0){scale=1}this.z=z;this.parallax=parallax;this.scale=scale;this.Camera=new Camera}Layer.prototype.enter=function(cx){var camera=this.Camera;var scale=this.scale*camera.zoom;var parallax=this.parallax;cx.save();cx.scale(scale,scale);cx.translate(-camera.x*parallax,-camera.y*parallax)};Layer.prototype.exit=function(cx){cx.restore()};return Layer}();Render.Layer=Layer;var RenderList=function(){function RenderList(){this.items=[]}RenderList.prototype.reset=function(){this.items.length=0};RenderList.prototype.add=function(item){this.items.push(item)};RenderList.prototype.drawTo=function(cx){this.items.sort(function(a,b){return a.Layer.z-b.Layer.z});for(var _i=0,_a=this.items;_i<_a.length;_i++){var item=_a[_i];item.Layer.enter(cx);item.render(cx);item.Layer.exit(cx)}};return RenderList}();Render.RenderList=RenderList})(Render||(Render={}));var ECS;(function(ECS){var Location=function(){function Location(X,Y,Angle){if(Angle===void 0){Angle=0}this.X=X;this.Y=Y;this.Angle=Angle;this.VX=0;this.VY=0;this.VAngle=0}Location.prototype.transformCx=function(cx){cx.translate(this.X,this.Y);cx.rotate(this.Angle)};return Location}();ECS.Location=Location;function HasLocation(item){return item.Location!=null}ECS.HasLocation=HasLocation})(ECS||(ECS={}));var RenderDebug;(function(RenderDebug){var Box=function(){function Box(Layer,bounds,color){if(color===void 0){color="#f00"}this.Layer=Layer;this.bounds=bounds;this.color=color;this.Location=null}Box.prototype.render=function(cx){var b=this.bounds;cx.fillStyle=this.color;if(this.Location){this.Location.transformCx(cx)}cx.fillRect(b.x,b.y,b.w,b.h)};return Box}();RenderDebug.Box=Box;function HasBox(item){return item.RenderDebugBox!=null}RenderDebug.HasBox=HasBox;var System=function(_super){__extends(System,_super);function System(renderer){_super.call(this,HasBox);this.renderer=renderer}System.prototype.process=function(item){item.RenderDebugBox.Location=ECS.HasLocation(item)?item.Location:null;this.renderer.add(item.RenderDebugBox)};return System}(ECS.System);RenderDebug.System=System})(RenderDebug||(RenderDebug={}));var Mouse;(function(Mouse){(function(UiLayer){UiLayer[UiLayer["Room"]=1]="Room";UiLayer[UiLayer["Object"]=2]="Object";UiLayer[UiLayer["Textbox"]=3]="Textbox"})(Mouse.UiLayer||(Mouse.UiLayer={}));var UiLayer=Mouse.UiLayer;var ClickTarget=function(){function ClickTarget(layer,bounds,callback){this.layer=layer;this.bounds=bounds;this.callback=callback}return ClickTarget}();Mouse.ClickTarget=ClickTarget;function HasTarget(entity){return entity.ClickTarget!=null}Mouse.HasTarget=HasTarget;function IsCursor(entity){return entity.IsCursor==true&&ECS.HasLocation(entity)}Mouse.IsCursor=IsCursor;function MakeCursor(entity){entity.IsCursor=true}Mouse.MakeCursor=MakeCursor;function CancelCursor(entity){entity.IsCursor=false}Mouse.CancelCursor=CancelCursor;var MouseControl=function(){function MouseControl(element,room){this.element=element;this.room=room;this.x=0;this.y=0;this.element.addEventListener("mousedown",this.doClick.bind(this),false);this.element.addEventListener("mousemove",this.doMove.bind(this),false)}MouseControl.prototype.doClick=function(event){var x=event.offsetX;var y=event.offsetY;var targets=this.room.Entities.filter(function(entity){return HasTarget(entity)&&!IsCursor(entity)});var topLayer=targets.map(function(entity){return entity.ClickTarget.layer}).reduce(function(a,b){return Math.max(a,b)},0);var cursors=this.room.Entities.filter(IsCursor);targets.filter(function(entity){return entity.ClickTarget.layer==topLayer||entity.ClickTarget.layer==null}).filter(function(entity){var box=entity.ClickTarget.bounds;var relX=x,relY=y;if(ECS.HasLocation(entity)){relX-=entity.Location.X;relY-=entity.Location.Y}return relX>=box.x&&relX<box.x+box.w&&(relY>=box.y&&relY<box.y+box.h)}).map(function(entity){entity.ClickTarget.callback(cursors[0]||null)});this.room.cleanup()};MouseControl.prototype.doMove=function(event){var _this=this;this.x=event.offsetX;this.y=event.offsetY;var cursors=this.room.Entities.filter(IsCursor);cursors.map(function(entity){entity.Location.X=_this.x;entity.Location.Y=_this.y})};return MouseControl}();Mouse.MouseControl=MouseControl})(Mouse||(Mouse={}));var Pin;(function(Pin){var PinTo=function(){function PinTo(Parent,X,Y){if(X===void 0){X=0}if(Y===void 0){Y=0}this.Parent=Parent;this.X=X;this.Y=Y}return PinTo}();Pin.PinTo=PinTo;function HasPin(entity){return entity.PinTo!=null&&ECS.HasLocation(entity)}Pin.HasPin=HasPin;var PinSystem=function(_super){__extends(PinSystem,_super);function PinSystem(){_super.call(this,HasPin)}PinSystem.prototype.process=function(entity){var offset=this.calcOffset(entity);entity.Location.X=offset.x;entity.Location.Y=offset.y};PinSystem.prototype.calcOffset=function(entity){var pin=entity.PinTo;var parent=pin.Parent;var x=parent.Location.X;var y=parent.Location.Y;if(HasPin(parent)){var parentOffset=this.calcOffset(parent);x=parentOffset.x;y=parentOffset.y}x+=pin.X;y+=pin.Y;return{x:x,y:y,rot:0}};return PinSystem}(ECS.System);Pin.PinSystem=PinSystem;function Attach(parent,child,x,y){child.Location=new ECS.Location(0,0);child.PinTo=new PinTo(parent,x,y)}Pin.Attach=Attach})(Pin||(Pin={}));var Slide;(function(Slide_1){var SlideBehavior=function(){function SlideBehavior(TargetX,TargetY,Speed,Callback){if(TargetX===void 0){TargetX=0}if(TargetY===void 0){TargetY=0}if(Speed===void 0){Speed=10}if(Callback===void 0){Callback=function(){}}this.TargetX=TargetX;this.TargetY=TargetY;this.Speed=Speed;this.Callback=Callback}return SlideBehavior}();Slide_1.SlideBehavior=SlideBehavior;function HasSlideBehavior(entity){return entity.SlideBehavior!=null&&ECS.HasLocation(entity)}Slide_1.HasSlideBehavior=HasSlideBehavior;var SlideSystem=function(_super){__extends(SlideSystem,_super);function SlideSystem(){_super.call(this,HasSlideBehavior)}SlideSystem.prototype.process=function(entity){if(entity.Location.X>entity.SlideBehavior.TargetX){entity.Location.X-=entity.SlideBehavior.Speed}if(entity.Location.X<=entity.SlideBehavior.TargetX){entity.Location.X=entity.SlideBehavior.TargetX;var callback=entity.SlideBehavior.Callback;entity.SlideBehavior=null;callback()}};return SlideSystem}(ECS.System);Slide_1.SlideSystem=SlideSystem;function Slide(entity,x,y,speed,callback){if(callback===void 0){callback=function(){}}var slideBehavior=new SlideBehavior(x,y,speed,callback);entity.SlideBehavior=slideBehavior}Slide_1.Slide=Slide})(Slide||(Slide={}));var RenderImage;(function(RenderImage_1){var RenderImage=function(){function RenderImage(Layer,Image,X,Y,W,H,XOffset,YOffset){if(X===void 0){X=0}if(Y===void 0){Y=0}if(W===void 0){W=32}if(H===void 0){H=32}if(XOffset===void 0){XOffset=0}if(YOffset===void 0){YOffset=0}this.Layer=Layer;this.Image=Image;this.X=X;this.Y=Y;this.W=W;this.H=H;this.XOffset=XOffset;this.YOffset=YOffset;this.Location=new ECS.Location(0,0)}RenderImage.prototype.render=function(cx){this.Location.transformCx(cx);cx.drawImage(this.Image,this.X,this.Y,this.W,this.H,this.XOffset,this.YOffset,this.W,this.H)};return RenderImage}();RenderImage_1.RenderImage=RenderImage;function HasImage(entity){return entity.RenderImage!=null}RenderImage_1.HasImage=HasImage;var RenderImageSystem=function(_super){__extends(RenderImageSystem,_super);function RenderImageSystem(renderer){_super.call(this,HasImage);this.renderer=renderer}RenderImageSystem.prototype.process=function(entity){if(ECS.HasLocation(entity)){entity.RenderImage.Location=entity.Location}this.renderer.add(entity.RenderImage)};return RenderImageSystem}(ECS.System);RenderImage_1.RenderImageSystem=RenderImageSystem;function load(url){var img=new Image;img.src=url;return img}RenderImage_1.load=load})(RenderImage||(RenderImage={}));var Textbox;(function(Textbox){var FONT_SIZE=16;var BACKGROUND=RenderImage.load("img/dialog.png");var Text=function(){function Text(Layer,Text){this.Layer=Layer;this.Text=Text;this.Location=new ECS.Location(0,0)}Text.prototype.render=function(cx){cx.fillStyle="#fff";cx.font=FONT_SIZE+"px Roboto, sans-serif";cx.textAlign="center";cx.textBaseline="top";this.Location.transformCx(cx);var lines=this.Text.split("\n");var y=0;lines.map(function(line){cx.fillText(line,0,y);y+=FONT_SIZE})};return Text}();Textbox.Text=Text;function HasText(entity){return entity.RenderText!=null}Textbox.HasText=HasText;var RenderTextSystem=function(_super){__extends(RenderTextSystem,_super);function RenderTextSystem(renderer){_super.call(this,HasText);this.renderer=renderer}RenderTextSystem.prototype.process=function(entity){if(ECS.HasLocation(entity)){entity.RenderText.Location=entity.Location}this.renderer.add(entity.RenderText)};return RenderTextSystem}(ECS.System);Textbox.RenderTextSystem=RenderTextSystem;var SLIDE_SPEED=70;function MessageBox(entities,bgLayer,layer,text,callback){if(callback===void 0){callback=null}var root={deleted:false,Location:new ECS.Location(500,0),RenderImage:new RenderImage.RenderImage(bgLayer,BACKGROUND,0,0,500,400)};Slide.Slide(root,0,0,SLIDE_SPEED);var message={deleted:false,RenderText:new Text(layer,text)};Pin.Attach(root,message,250,50+FONT_SIZE);var dismissBox=new Render.Box(210,225,80,30);var dismissButton={deleted:false,ClickTarget:new Mouse.ClickTarget(Mouse.UiLayer.Textbox,dismissBox,function(clickedWith){return Slide.Slide(root,-500,0,SLIDE_SPEED,function(){root.deleted=true;message.deleted=true;dismissButton.deleted=true;if(callback){callback()}})})};Pin.Attach(root,dismissButton,0,0);entities.push(root,message,dismissButton)}Textbox.MessageBox=MessageBox})(Textbox||(Textbox={}));var InventoryItemType;(function(InventoryItemType){InventoryItemType[InventoryItemType["Shovel"]=0]="Shovel";InventoryItemType[InventoryItemType["Screwdriver"]=1]="Screwdriver";InventoryItemType[InventoryItemType["Lead"]=2]="Lead";InventoryItemType[InventoryItemType["Gold"]=3]="Gold";InventoryItemType[InventoryItemType["Seed"]=4]="Seed";InventoryItemType[InventoryItemType["Bone"]=5]="Bone";InventoryItemType[InventoryItemType["Mug"]=6]="Mug";InventoryItemType[InventoryItemType["Zorp"]=7]="Zorp"})(InventoryItemType||(InventoryItemType={}));var InventoryItem=function(){function InventoryItem(Type){this.Type=Type;this.List=null}InventoryItem.prototype.remove=function(){if(this.List){var index=this.List.indexOf(this.Type);if(index>=0){this.List.splice(index,1)}}var oldList=this.List;this.List=null;return oldList};InventoryItem.prototype.addTo=function(list){this.remove();this.List=list;list.push(this.Type)};return InventoryItem}();function HasInventoryItem(entity){return entity.InventoryItem!=null}function IsInventoryItem(entity,type){return Boolean(entity&&HasInventoryItem(entity)&&entity.InventoryItem.Type==type)}var GuiRoom=function(_super){__extends(GuiRoom,_super);function GuiRoom(fps,State){_super.call(this,fps);this.State=State;this.renderer=new Render.RenderList;this.BackgroundLayer=new Render.Layer(-1,0);this.DropLayer=new Render.Layer(0,0);this.RoomLayer=new Render.Layer(1,0);this.ObjectBgLayer=new Render.Layer(1.9,0);this.ObjectLayer=new Render.Layer(2,0);this.TextboxBgLayer=new Render.Layer(2.9,0);this.TextboxLayer=new Render.Layer(3,0);this.CursorLayer=new Render.Layer(10,0);this.SlideSystem=new Slide.SlideSystem;this.PinSystem=new Pin.PinSystem;this.DebugRenderSystem=new RenderDebug.System(this.renderer);this.TextRenderSystem=new Textbox.RenderTextSystem(this.renderer);this.ImageRenderSystem=new RenderImage.RenderImageSystem(this.renderer)}GuiRoom.prototype.runPhysics=function(){this.SlideSystem.run(this.Entities);this.PinSystem.run(this.Entities);this.cleanup()};GuiRoom.prototype.runRender=function(cx){cx.fillStyle="#000";cx.fillRect(0,0,500,400);this.renderer.reset();this.TextRenderSystem.run(this.Entities);this.ImageRenderSystem.run(this.Entities);this.renderer.drawTo(cx)};GuiRoom.prototype.showMessageBox=function(message,callback){if(callback===void 0){callback=null}Textbox.MessageBox(this.Entities,this.TextboxBgLayer,this.TextboxLayer,message,callback)};GuiRoom.prototype.makeDummyObject=function(color,x,y,label){var _this=this;var bounds=new Render.Box(-16,0,32,20);var entity={Location:new ECS.Location(x,y),RenderDebugBox:new RenderDebug.Box(this.RoomLayer,bounds,color),RenderText:new Textbox.Text(this.RoomLayer,label)};this.onClick(entity,function(clickedWith){if(clickedWith==null&&HasInventoryItem(entity)){entity.RenderDebugBox.Layer=_this.CursorLayer;entity.RenderText.Layer=_this.CursorLayer;entity.InventoryItem.remove();Mouse.MakeCursor(entity)}});this.Entities.push(entity);return entity};GuiRoom.prototype.onClick=function(entity,callback){if(Mouse.HasTarget(entity)){entity.ClickTarget.callback=callback}else{entity.ClickTarget=new Mouse.ClickTarget(Mouse.UiLayer.Room,entity.RenderDebugBox.bounds,callback)}};GuiRoom.prototype.assignInventoryItem=function(entity,type,existingList){if(existingList===void 0){existingList=null}if(HasInventoryItem(entity)){var list=entity.InventoryItem.remove();entity.InventoryItem.Type=type;if(existingList||list){entity.InventoryItem.addTo(existingList||list)}}else{var inventoryItem=new InventoryItem(type);inventoryItem.List=existingList;entity.InventoryItem=inventoryItem}};GuiRoom.prototype.makeInventoryDropper=function(bounds,list,clickLayer,itemLayer){if(clickLayer===void 0){clickLayer=Mouse.UiLayer.Room}var entity={RenderDebugBox:new RenderDebug.Box(this.DropLayer,bounds,"rgba(150,150,150,0.5)"),ClickTarget:new Mouse.ClickTarget(clickLayer,bounds,function(clickedWith){if(clickedWith!=null&&HasInventoryItem(clickedWith)){if(RenderDebug.HasBox(clickedWith)){clickedWith.RenderDebugBox.Layer=itemLayer}if(RenderImage.HasImage(clickedWith)){clickedWith.RenderImage.Layer=itemLayer}if(Textbox.HasText(clickedWith)){clickedWith.RenderText.Layer=itemLayer}if(Mouse.HasTarget(clickedWith)){clickedWith.ClickTarget.layer=clickLayer}clickedWith.InventoryItem.addTo(list);Mouse.CancelCursor(clickedWith)}})};this.Entities.push(entity);return entity};return GuiRoom}(ECS.Room);var TimePeriod;(function(TimePeriod){TimePeriod[TimePeriod["Alchemy"]=0]="Alchemy";TimePeriod[TimePeriod["Present"]=1]="Present";TimePeriod[TimePeriod["Future"]=2]="Future"})(TimePeriod||(TimePeriod={}));var GameState=function(){function GameState(){this.TimePeriod=TimePeriod.Present;this.PastTable=new Array;this.PastHole=new Array;this.PastTimeCapsule=[InventoryItemType.Screwdriver,InventoryItemType.Bone];this.TimeCapsuleUncovered=false;this.TimeCapsuleViewed=false;this.PresentTable=[InventoryItemType.Mug];this.PresentDesk=new Array;this.DinosaurSummoned=false;this.FutureTable=[InventoryItemType.Shovel,InventoryItemType.Zorp];this.FutureVault=[InventoryItemType.Seed];this.FutureDinosaur=[InventoryItemType.Lead];this.Inventory=new Array;this.AlchemyBg=RenderImage.load("img/alchemy.png");this.AlchemyBgCapsule=RenderImage.load("img/wcapsule.png");this.PresentBg=RenderImage.load("img/present.png");this.PresentBgDino=RenderImage.load("img/wdino.png");this.PresentBgBean=RenderImage.load("img/wbeanstalk.png");this.FutureBg=RenderImage.load("img/future.png");this.FutureBgDino=RenderImage.load("img/wskel.png");this.DialogBg=RenderImage.load("img/dialog.png");this.Buttons=RenderImage.load("img/buttons.png");this.Items=RenderImage.load("img/items.png")}return GameState}();function IsGenerated(entity){return entity.Generated==true}function MarkGenerated(entity){entity.Generated=true}function GenerateClickZone(room,x,y,w,h,callback,uiLayer,renderLayer){if(callback===void 0){callback=function(clickedBy){}}if(uiLayer===void 0){uiLayer=Mouse.UiLayer.Room}if(renderLayer===void 0){renderLayer=null}renderLayer=renderLayer||room.RoomLayer;var bounds=new Render.Box(0,0,w,h);var entity={Location:new ECS.Location(x,y),Generated:true,ClickTarget:new Mouse.ClickTarget(uiLayer,bounds,callback),RenderDebugBox:new RenderDebug.Box(renderLayer,bounds,"rgba(255,0,0,0.5)")};room.add(entity);return entity}function PopulateItem(room,type,x,y,list){var color="#000";var name=InventoryItemType[type];switch(type){case InventoryItemType.Shovel:color="#888";break;case InventoryItemType.Seed:color="#0f0";break}var entity={Location:new ECS.Location(x,y),Generated:true,RenderImage:new RenderImage.RenderImage(room.RoomLayer,room.State.Items,type*32,0,32,32,-16,-16),InventoryItem:new InventoryItem(type),ClickTarget:new Mouse.ClickTarget(Mouse.UiLayer.Room,new Render.Box(-16,-16,32,32),function(clickedWith){if(clickedWith==null){entity.RenderImage.Layer=room.CursorLayer;entity.InventoryItem.remove();Mouse.MakeCursor(entity)}})};room.add(entity);entity.InventoryItem.List=list;console.log(entity);return entity}function PopulateDropTarget(room,list,target,layer){if(layer===void 0){layer=null}var bounds=target.ClickTarget.bounds;var x=bounds.x+20;var y=bounds.y+bounds.h/2;var itemLayer=layer||room.RoomLayer;list.map(function(item){var entity=PopulateItem(room,item,x,y,list);entity.RenderImage.Layer=itemLayer;entity.ClickTarget.layer=target.ClickTarget.layer;x=x+40})}function GenerateDropTarget(room,list,bounds,uiLayer,renderLayer){if(uiLayer===void 0){uiLayer=Mouse.UiLayer.Room}if(renderLayer===void 0){renderLayer=null}renderLayer=renderLayer||room.RoomLayer;var target=room.makeInventoryDropper(bounds,list,uiLayer,renderLayer);MarkGenerated(target);PopulateDropTarget(room,list,target,renderLayer);return target}function ToObjectLayer(room,entity){if(Mouse.HasTarget(entity)){entity.ClickTarget.layer=Mouse.UiLayer.Object}if(RenderDebug.HasBox(entity)){entity.RenderDebugBox.Layer=room.ObjectLayer}if(Textbox.HasText(entity)){entity.RenderText.Layer=room.ObjectLayer}}function PopupTimeMachine(room){var makeButton=function(x,time,clickFunc){var button={Location:new ECS.Location(150+x,150),Generated:true,RenderImage:new RenderImage.RenderImage(room.ObjectLayer,room.State.Buttons,x,0,50,50),ClickTarget:new Mouse.ClickTarget(Mouse.UiLayer.Object,new Render.Box(0,0,50,50),clickFunc||function(clickedBy){room.State.TimePeriod=time;GenerateRoom(room)})};room.add(button)};var root={Generated:true,Location:new ECS.Location(0,0),RenderImage:new RenderImage.RenderImage(room.ObjectBgLayer,room.State.DialogBg,0,0,500,400)};room.add(root);var text="It's a time machine!\n\nWhen would you like to go today?";var message={Generated:true,Location:new ECS.Location(250,50+16),RenderText:new Textbox.Text(room.ObjectLayer,text)};room.add(message);if(room.State.TimeCapsuleViewed&&!room.State.DinosaurSummoned){makeButton(0,TimePeriod.Present,function(clickedBy){room.showMessageBox("Dangit, the machine won't let you escape the room\nvia time travel. Instead, it summons the creature\nof interest to the present.");room.State.DinosaurSummoned=true;room.State.TimePeriod=TimePeriod.Present;GenerateRoom(room)})}makeButton(50,TimePeriod.Alchemy);makeButton(100,TimePeriod.Present);makeButton(150,TimePeriod.Future);var dismissBox=new Render.Box(210,225,80,30);var back={Generated:true,ClickTarget:new Mouse.ClickTarget(Mouse.UiLayer.Object,dismissBox,function(clickedBy){if(clickedBy==null){GenerateRoom(room)}})};room.add(back)}function PopupItemBox(room,list,text){var cancel;var root={Generated:true,Location:new ECS.Location(0,0),RenderImage:new RenderImage.RenderImage(room.ObjectBgLayer,room.State.DialogBg,0,0,500,400)};room.add(root);var message={Generated:true,Location:new ECS.Location(250,50+16),RenderText:new Textbox.Text(room.ObjectLayer,text)};room.add(message);var contents=GenerateDropTarget(room,list,new Render.Box(200,180,100,30),Mouse.UiLayer.Object,room.ObjectLayer);ToObjectLayer(room,contents);var dismissBox=new Render.Box(210,225,80,30);var back={Generated:true,ClickTarget:new Mouse.ClickTarget(Mouse.UiLayer.Object,dismissBox,function(clickedBy){if(clickedBy==null){GenerateRoom(room)}})};room.add(back)}function GenerateRoom(room){var State=room.State;room.Entities.map(function(entity){if(IsGenerated(entity)){entity.deleted=true}});var funded=room.State.PresentDesk.indexOf(InventoryItemType.Gold)>=0;var seedPlanted=State.PastHole.indexOf(InventoryItemType.Seed)>-1;var background=null;switch(State.TimePeriod){case TimePeriod.Alchemy:background=State.AlchemyBg;if(!State.TimeCapsuleUncovered){GenerateClickZone(room,329,254,37,25,function(clickedBy){if(IsInventoryItem(clickedBy,InventoryItemType.Shovel)){State.TimeCapsuleUncovered=true;GenerateRoom(room)}})}else{background=State.AlchemyBgCapsule;GenerateDropTarget(room,State.PastHole,new Render.Box(329,254,37,25));GenerateClickZone(room,172,190,92,100,function(clickedBy){if(clickedBy==null){State.TimeCapsuleViewed=true;PopupItemBox(room,State.PastTimeCapsule,"We leave this time capsule to be found by the future.\nIncluded:\n- A dazzling new invention, the screwdriver!\n- A strange bone. From a big lizard?\nAlchemy says it lived 67 million years ago.\nAnd died of lead poisoning.\nAnother reason we must turn all lead to gold.")}})}GenerateClickZone(room,235,127,60,21,function(clickedBy){if(clickedBy==null){room.showMessageBox("It's an alchemist's table.")}else if(IsInventoryItem(clickedBy,InventoryItemType.Lead)){clickedBy.deleted=true;State.PastTable.push(InventoryItemType.Gold);GenerateRoom(room)}});GenerateDropTarget(room,State.PastTable,new Render.Box(299,127,60,21));break;case TimePeriod.Present:background=State.PresentBg;GenerateClickZone(room,188,231,69,54,function(clickedBy){if(clickedBy==null){var digText="";if(!State.TimeCapsuleUncovered){digText="A time capsule from the 1500s was discovered\nwhile digging the new basement; it was directly\nunder our office chair!\n"}else{digText="A time capsule from the 1500s was discovered\nwhile digging the new basement; it was boring.\n"}room.showMessageBox("==NEWS==\n"+digText+"\nAlso, the university seed vault project is\nlooking for funding; please leave any donations\non the office desk.")}});GenerateClickZone(room,412,8,69,39,function(clickedBy){if(!seedPlanted){room.showMessageBox("It's out of reach!");return}if(IsInventoryItem(clickedBy,InventoryItemType.Screwdriver)){room.showMessageBox("Working the grate off with the screwdriver,\nyou open up a path to freedom!\n\nYou Win! Resetting game...",function(){return ResetGame(room)})}else{room.showMessageBox("The grate's screwed on tightly.")}});if(State.DinosaurSummoned){background=State.PresentBgDino;GenerateClickZone(room,27,185,151,115,function(clickedBy){if(clickedBy==null){room.showMessageBox("It's a very confused dinosaur.")}})}if(seedPlanted){background=State.PresentBgBean;GenerateClickZone(room,419,49,70,152,function(clickedBy){if(clickedBy==null){room.showMessageBox("Though it was transplanted,\nthis beanstalk is still growing strong.")}})}GenerateDropTarget(room,State.PresentTable,new Render.Box(220,124,142,28));GenerateDropTarget(room,State.PresentDesk,new Render.Box(261,176,49,85));break;case TimePeriod.Future:background=State.FutureBg;if(State.DinosaurSummoned){background=State.FutureBgDino;GenerateDropTarget(room,State.FutureDinosaur,new Render.Box(61,264,96,29))}GenerateDropTarget(room,State.FutureTable,new Render.Box(208,124,164,28));GenerateClickZone(room,410,44,79,151,function(clickedBy){if(clickedBy==null){if(funded){PopupItemBox(room,room.State.FutureVault,"It's a seed vault!\nThere are lots of seeds.\nThe beanstalk seeds look interesting.")}else{room.showMessageBox("It might be a seed vault?\nBudget cuts leave it looking pretty empty.")}}});break}PopulateDropTarget(room,State.Inventory,State.InventoryBox);if(background){room.add({RenderImage:new RenderImage.RenderImage(room.BackgroundLayer,background,0,0,500,400),Generated:true})}GenerateClickZone(room,39,70,82,107,function(clickedBy){if(clickedBy==null){room.showMessageBox("The door is utterly locked.")}});GenerateClickZone(room,428,198,57,103,function(clickedBy){if(clickedBy==null){PopupTimeMachine(room)}})}function ResetGame(room){room.Entities.map(function(entity){entity.deleted=true});room.State=new GameState;room.State.InventoryBox=room.makeInventoryDropper(new Render.Box(0,300,500,100),room.State.Inventory,null,room.RoomLayer);GenerateRoom(room);room.showMessageBox("You're trapped in a university lab's office!\nCan you make an escape?")}var EscapeMain=function(){function EscapeMain(element){this.element=element;this.room=new GuiRoom(30,new GameState);var cx=element.getContext("2d");ResetGame(this.room);new Mouse.MouseControl(this.element,this.room);this.loop=new ECS.Loop(this.room,cx);this.loop.start()}EscapeMain=__decorate([Applet.Bind("canvas")],EscapeMain);return EscapeMain}();
